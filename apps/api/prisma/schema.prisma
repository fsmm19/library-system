generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @db.VarChar(255)
  role         Role
  firstName    String    @db.VarChar(100)
  middleName   String?   @db.VarChar(100)
  lastName     String    @db.VarChar(100)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  member    Member?
  librarian Librarian?

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Member {
  userId       String            @id @db.Uuid
  accountState AccountState
  conditions   MemberCondition[] @default([])

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  loans        Loan[]
  reservations Reservation[]

  @@index([accountState])
  @@map("members")
}

model Librarian {
  userId   String    @id @db.Uuid
  isActive Boolean   @default(true)
  hireDate DateTime  @db.Date
  endDate  DateTime? @db.Date

  user           User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  processedLoans Loan[] @relation("ProcessedLoans")
  issuedFines    Fine[] @relation("IssuedFines")

  @@map("librarians")
}

enum Role {
  MEMBER
  LIBRARIAN
}

enum AccountState {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MemberCondition {
  HAS_LATE_RETURN
  HAS_FINE
  LOST_COPY
}

enum MaterialType {
  BOOK
  MAGAZINE
  DVD
  OTHER
}

enum Language {
  EN
  ES
  FR
  DE
  OTHER
}

enum MaterialCopyCondition {
  NEW
  GOOD
  FAIR
  DAMAGED
  LOST
}

enum MaterialCopyStatus {
  AVAILABLE
  BORROWED
  RESERVED
  UNDER_REPAIR
  REMOVED
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
  CANCELLED
}

enum FineStatus {
  PENDING
  PAID
  WAIVED
}

enum ReservationStatus {
  PENDING
  READY
  PICKED_UP
  EXPIRED
  CANCELLED
}

model Material {
  id            String       @id @default(uuid()) @db.Uuid
  title         String       @db.VarChar(500)
  subtitle      String?      @db.VarChar(500)
  description   String?      @db.Text
  type          MaterialType
  language      Language
  publishedDate DateTime?    @db.Date
  maxLoanDays   Int?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  authors      Author[]
  categories   Category[]
  book         Book?
  copies       MaterialCopy[]
  reservations Reservation[]

  @@index([title])
  @@index([type])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("materials")
}

model Category {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(255)

  materials Material[]

  @@map("categories")
}

model Author {
  id                String    @id @default(uuid()) @db.Uuid
  firstName         String    @db.VarChar(100)
  middleName        String?   @db.VarChar(100)
  lastName          String    @db.VarChar(100)
  countryOfOriginId String?   @db.Uuid
  countryOfOrigin   Country?  @relation(fields: [countryOfOriginId], references: [id])
  birthDate         DateTime? @db.Date

  materials Material[]

  @@unique([firstName, middleName, lastName, countryOfOriginId])
  @@index([lastName, firstName])
  @@map("authors")
}

model Country {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(100)

  authors Author[]

  @@map("countries")
}

model Book {
  id            String  @id @default(uuid()) @db.Uuid
  isbn13        String? @unique @db.VarChar(13)
  edition       String? @db.VarChar(100)
  numberOfPages Int?

  materialId String   @unique @db.Uuid
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  publisherId String?    @db.Uuid
  publisher   Publisher? @relation(fields: [publisherId], references: [id], onDelete: Restrict)

  @@index([isbn13])
  @@map("books")
}

model Publisher {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(255)

  books Book[]

  @@map("publishers")
}

model MaterialCopy {
  id              String                @id @default(uuid()) @db.Uuid
  acquisitionDate DateTime              @db.Date
  condition       MaterialCopyCondition
  status          MaterialCopyStatus
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  location        String?               @db.VarChar(100)
  barcode         String?               @unique @db.VarChar(255)
  catalogCode     String                @unique @db.VarChar(50)

  materialId   String        @db.Uuid
  material     Material      @relation(fields: [materialId], references: [id], onDelete: Cascade)
  loans        Loan[]
  reservations Reservation[]

  @@index([materialId])
  @@index([status])
  @@index([condition])
  @@index([createdAt])
  @@map("material_copies")
}

model Loan {
  id           String     @id @default(uuid()) @db.Uuid
  loanDate     DateTime   @db.Date
  dueDate      DateTime   @db.Date
  returnDate   DateTime?  @db.Date
  status       LoanStatus
  renewalCount Int        @default(0)
  notes        String?    @db.Text
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  memberId String @db.Uuid
  member   Member @relation(fields: [memberId], references: [userId], onDelete: Restrict)

  copyId String       @db.Uuid
  copy   MaterialCopy @relation(fields: [copyId], references: [id], onDelete: Restrict)

  processedById String    @db.Uuid
  processedBy   Librarian @relation("ProcessedLoans", fields: [processedById], references: [userId], onDelete: Restrict)

  fines Fine[]

  @@index([memberId])
  @@index([copyId])
  @@index([status])
  @@index([loanDate])
  @@index([dueDate])
  @@index([processedById])
  @@map("loans")
}

model Fine {
  id         String     @id @default(uuid()) @db.Uuid
  amount     Float      @db.DoublePrecision
  paidAmount Float      @default(0) @db.DoublePrecision
  status     FineStatus @default(PENDING)
  reason     String     @db.VarChar(500)
  notes      String?    @db.Text
  paidDate   DateTime?  @db.Date
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?

  loanId String @db.Uuid
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  issuedById String    @db.Uuid
  issuedBy   Librarian @relation("IssuedFines", fields: [issuedById], references: [userId], onDelete: Restrict)

  @@index([loanId])
  @@index([status])
  @@index([issuedById])
  @@index([createdAt])
  @@map("fines")
}

model LoanConfiguration {
  id                  String   @id @default(uuid()) @db.Uuid
  defaultLoanDays     Int      @default(14)
  maxActiveLoans      Int      @default(5)
  maxRenewals         Int      @default(2)
  gracePeriodDays     Int      @default(0)
  dailyFineAmount     Float    @default(1.0) @db.DoublePrecision
  allowLoansWithFines Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("loan_configuration")
}

model Reservation {
  id              String            @id @default(uuid()) @db.Uuid
  reservationDate DateTime          @default(now())
  expirationDate  DateTime?         @db.Date
  status          ReservationStatus @default(PENDING)
  queuePosition   Int?
  notes           String?           @db.Text
  confirmedAt     DateTime?
  pickedUpAt      DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  memberId String @db.Uuid
  member   Member @relation(fields: [memberId], references: [userId], onDelete: Restrict)

  copyId String?       @db.Uuid
  copy   MaterialCopy? @relation(fields: [copyId], references: [id], onDelete: Restrict)

  materialId String   @db.Uuid
  material   Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([memberId])
  @@index([copyId])
  @@index([materialId])
  @@index([status])
  @@index([reservationDate])
  @@map("reservations")
}
