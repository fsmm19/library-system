generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @db.VarChar(255)
  role         Role
  firstName    String    @db.VarChar(100)
  middleName   String?   @db.VarChar(100)
  lastName     String    @db.VarChar(100)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  member    Member?
  librarian Librarian?

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Member {
  userId       String            @id @db.Uuid
  accountState AccountState
  conditions   MemberCondition[] @default([])

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountState])
  @@map("members")
}

model Librarian {
  userId   String    @id @db.Uuid
  isActive Boolean   @default(true)
  hireDate DateTime  @db.Date
  endDate  DateTime? @db.Date

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("librarians")
}

enum Role {
  MEMBER
  LIBRARIAN
}

enum AccountState {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum MemberCondition {
  HAS_LATE_RETURN
  HAS_FINE
  LOST_COPY
}

enum MaterialType {
  BOOK
  MAGAZINE
  DVD
  OTHER
}

enum MaterialCopyCondition {
  NEW
  GOOD
  FAIR
  DAMAGED
  LOST
}

enum MaterialCopyStatus {
  AVAILABLE
  BORROWED
  RESERVED
  UNDER_REPAIR
  REMOVED
}

model Material {
  id            String        @id @default(uuid()) @db.Uuid
  title         String        @db.VarChar(500)
  subtitle      String?       @db.VarChar(500)
  description   String?       @db.Text
  type          MaterialType
  language      String        @db.VarChar(50)
  publishedDate DateTime?     @db.Date
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  authors Author[]
  book    Book?
  copies  MaterialCopy[]

  @@index([title])
  @@index([type])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("materials")
}

model Author {
  id          String    @id @default(uuid()) @db.Uuid
  firstName   String    @db.VarChar(100)
  middleName  String?   @db.VarChar(100)
  lastName    String    @db.VarChar(100)
  nationality String?   @db.VarChar(100)
  birthDate   DateTime? @db.Date

  materials Material[]

  @@unique([firstName, middleName, lastName, nationality])
  @@index([lastName, firstName])
  @@map("authors")
}

model Book {
  id            String  @id @default(uuid()) @db.Uuid
  isbn13        String? @unique @db.VarChar(13)
  edition       String? @db.VarChar(100)
  numberOfPages Int?

  materialId String   @unique @db.Uuid
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([isbn13])
  @@map("books")
}

model MaterialCopy {
  id              String                 @id @default(uuid()) @db.Uuid
  acquisitionDate DateTime               @db.Date
  condition       MaterialCopyCondition
  status          MaterialCopyStatus
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  deletedAt       DateTime?

  materialId String   @db.Uuid
  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([status])
  @@index([condition])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("material_copies")
}
